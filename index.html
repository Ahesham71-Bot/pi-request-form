<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Proforma Invoice Request</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f5f5f7;
      color: #1d1d1f;
      padding: 2em;
      max-width: 800px;
      margin: auto;
    }
    h1 { font-size: 2em; text-align: center; margin-bottom: 1em; }
    label, select, input, fieldset {
      display: block;
      margin-bottom: 1em;
      width: 100%;
      font-size: 1em;
    }
    fieldset {
      padding: 1em;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      background: white;
    }
    button {
      background-color: #0071e3;
      color: white;
      font-size: 1em;
      padding: 0.6em 2em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background-color: #005bb5; }
  </style>
</head>
<body>
  <h1>Proforma Invoice Request</h1>
  <form id="piForm">
    <label>Requested By: <input type="text" name="requested_by" required></label>
    <label>Requested For: <input type="text" name="requested_for" required></label>
    <label>Delivery Date (in weeks): <input type="number" name="delivery_weeks" required></label>
    <label>Delivery Type:
      <select name="delivery_type">
        <option value="CIF">CIF</option>
        <option value="Ex-Work">Ex-Work</option>
        <option value="Site Delivery">Site Delivery</option>
      </select>
    </label>
    <label>Payment Terms: <input type="text" name="payment_terms" required></label>
    <label>Client Name:
      <select name="client_name" id="clientDropdown" required></select>
    </label>
    <label>Number of Machines: <input type="number" name="machine_count" id="machine_count" min="1" required></label>

    <div id="machinesSection"></div>
    <button type="submit">Submit</button>
  </form>

  <script>
    const sheetID = "1q7ECseBFbLjZagcSE2aOlUNMnnzukygUHwFoQNb5Lno";
    const baseURL = `https://opensheet.elk.sh/${sheetID}`;

    const manufacturers = [
      "ALBA", "Durkopp", "Epa Akin", "Hashima", "Saloon",
      "Veith Systems", "SmartMRT", "SVEGA", "Vitoni",
      "TEMEL Makina", "Yilmak", "Jooke", "Lectra_Gerber",
      "Maccpi", "RoboTech", "PMM", "Martin", "Timtas"
    ];

    const clientDropdown = document.getElementById('clientDropdown');
    const machineCountInput = document.getElementById('machine_count');
    const machinesSection = document.getElementById('machinesSection');
    const form = document.getElementById('piForm');

    // Populate client dropdown
    async function populateClientDropdown() {
      try {
        const res = await fetch('https://opensheet.elk.sh/1-qt49otjNLX1uAGhbdJ7I4JucFP6x9mJNobAIEnwaMA/Client%20IDs');
        const clients = await res.json();
        clients.forEach(client => {
          const opt = document.createElement('option');
          opt.value = client['Client Name'];
          opt.textContent = client['Client Name'];
          clientDropdown.appendChild(opt);
        });
      } catch {
        alert('Failed to load client list');
      }
    }

    // Create manufacturer dropdown
    function createManufacturerDropdown(id) {
      let options = manufacturers.map(m => `<option value="${m}">${m}</option>`).join('');
      return `<select name="manufacturer_${id}" id="manufacturer_${id}" required>
                <option value="">Select Manufacturer</option>${options}
              </select>`;
    }

    // Populate machine dropdown based on manufacturer
    async function populateMachineDropdown(id, manufacturer) {
      const dropdown = document.getElementById(`machine_type_${id}`);
      dropdown.innerHTML = `<option value="">Loading...</option>`;
      try {
        const res = await fetch(`${baseURL}/${manufacturer}`);
        const machines = await res.json();
        dropdown.innerHTML = `<option value="">Select Machine</option>`;
        machines.forEach(row => {
          const label = `${row["Machine name"]} - ${row["Machine description"]}`;
          dropdown.innerHTML += `<option value="${row["Machine name"]}">${label}</option>`;
        });
      } catch {
        dropdown.innerHTML = `<option value="">Failed to load machines</option>`;
      }
    }

    // Handle machine count input
    machineCountInput.addEventListener('input', function () {
      const count = parseInt(this.value);
      machinesSection.innerHTML = '';
      if (isNaN(count) || count <= 0) return;

      for (let i = 1; i <= count; i++) {
        const fieldset = document.createElement('fieldset');
        fieldset.innerHTML = `
          <legend>Machine #${i}</legend>
          <label>Manufacturer: ${createManufacturerDropdown(i)}</label>
          <label>Machine Type:
            <select name="machine_type_${i}" id="machine_type_${i}" required>
              <option value="">Select Machine</option>
            </select>
          </label>
          <label>Quantity: <input type="number" name="quantity_${i}" required></label>
          <label>Price: <input type="number" name="price_${i}" required></label>
        `;
        machinesSection.appendChild(fieldset);

        document.getElementById(`manufacturer_${i}`).addEventListener('change', function () {
          populateMachineDropdown(i, this.value);
        });
      }
    });

    // Handle form submission
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      const response = await fetch('https://n8n.srv815640.hstgr.cloud/webhook/800ba158-7f33-4457-958d-a8f4cb883105', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert('Request submitted successfully!');
        this.reset();
        machinesSection.innerHTML = '';
      } else {
        alert('Failed to submit request.');
      }
    });

    // Initialize client dropdown
    populateClientDropdown();
  </script>
</body>
</html>
